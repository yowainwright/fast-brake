---
import SIDEBAR from "../../constants/sidebar";

const pathname = new URL(Astro.request.url).pathname;

const expandedSections = SIDEBAR.map((section) => {
  const isActive = section.items.some(item => item.href === pathname);
  return isActive;
});
---

<div class="drawer-side z-40 md:border-r md:border-base-content/10 lg:sticky lg:top-28 lg:h-[calc(100vh-7rem)]">
  <label for="my-drawer-2" aria-label="close sidebar" class="drawer-overlay"></label>
  <aside class="bg-base-100 w-72 sm:w-80 h-full overflow-y-auto z-40">
    <div class="p-4 pt-0 space-y-3">
      {SIDEBAR.map((navItem, index) => (
        <div class="sidebar-section">
          <button
            class="sidebar-toggle w-full flex items-center justify-between px-2 py-1.5 text-sm font-semibold text-base-content/70 uppercase tracking-wide font-outfit hover:text-base-content transition-colors"
            aria-expanded={expandedSections[index] ? "true" : "false"}
            data-section-index={index}
          >
            <span>{navItem.title}</span>
            <svg
              class={`sidebar-chevron w-4 h-4 transition-transform duration-200 ${expandedSections[index] ? 'rotate-90' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
          <div class={`sidebar-content ${expandedSections[index] ? '' : 'hidden'}`}>
            <div class="ml-2 mt-1 border-l-2 border-base-content/10">
              <ul class="menu menu-sm p-0 space-y-1">
                {navItem.items.map((item) => (
                  <li>
                    <a
                      href={item.href}
                      class={`py-2 px-3 hover:text-[#ff4500] hover:bg-[#ff4500]/10 transition relative ${
                        pathname === item.href
                          ? "text-[#ff4500] bg-[#ff4500]/10 font-medium before:absolute before:left-[-2px] before:top-0 before:bottom-0 before:w-0.5 before:bg-[#ff4500]"
                          : ""
                      }`}
                    >
                      <span class="flex items-center justify-between">
                        {item.title}
                        {item.label && (
                          <span class="ml-auto text-xs bg-[#ff4500]/20 text-[#ff4500] px-1.5 py-0.5 rounded">
                            {item.label}
                          </span>
                        )}
                      </span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          </div>
        </div>
      ))}
    </div>
  </aside>
</div>

<script>
  function initCollapsibleSidebar() {
    const toggleButtons = document.querySelectorAll('.sidebar-toggle');

    toggleButtons.forEach((button) => {
      button.addEventListener('click', () => {
        const section = button.parentElement;
        const content = section.querySelector('.sidebar-content');
        const chevron = button.querySelector('.sidebar-chevron');
        const isExpanded = button.getAttribute('aria-expanded') === 'true';

        button.setAttribute('aria-expanded', (!isExpanded).toString());

        if (isExpanded) {
          content.classList.add('hidden');
          chevron.classList.remove('rotate-90');
        } else {
          content.classList.remove('hidden');
          chevron.classList.add('rotate-90');
        }
      });
    });
  }

  document.addEventListener('DOMContentLoaded', initCollapsibleSidebar);
  document.addEventListener('astro:page-load', initCollapsibleSidebar);
</script>

<style>
  .sidebar-content {
    transition: max-height 0.3s ease-out;
  }

  .sidebar-chevron {
    transition: transform 0.2s ease;
  }
</style>
